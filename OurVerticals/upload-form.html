<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Management</title>
    <link rel="shortcut icon" href="/Images/YUVA logo.png" type="image/x-icon">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> -->
    <style>
        /* Add the root variables at the top */
        :root {
            /* India Theme Color Palette */
            --saffron-primary: #FF9933;
            --saffron-light: #FFB366;
            --saffron-dark: #E67300;
            --saffron-pale: #FFE5CC;
            --white-primary: #FFFFFF;
            --white-warm: #FAFAF9;
            --white-cream: #F5F5F4;
            --green-primary: #138808;
            --green-light: #22C55E;
            --green-dark: #0F6606;
            --green-pale: #D1FAE5;
            --navy-chakra: #000080;
            --navy-dark: #00005C;

            /* Semantic Colors */
            --color-primary: var(--navy-chakra);
            --color-secondary: var(--green-primary);
            --color-accent: var(--saffron-primary);
            --color-error: #ef4444;
            --color-error-pale: #fef2f2;
            --color-info-pale: #EBF4FF;

            /* Text & Background */
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-muted: #64748B;
            --text-on-dark: var(--white-primary);
            --text-on-accent: var(--white-primary);
            --bg-base: var(--white-warm);
            --bg-elevated: var(--white-primary);
            --bg-subtle: var(--white-cream);
            --bg-muted: #F1F5F9;
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;

            /* Gradients */
            --gradient-hero: linear-gradient(135deg, var(--saffron-light) 0%, var(--white-primary) 50%, var(--green-light) 100%);
            --gradient-saffron: linear-gradient(135deg, var(--saffron-primary) 0%, var(--saffron-dark) 100%);
            --gradient-green: linear-gradient(135deg, var(--green-light) 0%, var(--green-primary) 100%);
            --gradient-navy: linear-gradient(135deg, var(--navy-chakra) 0%, var(--navy-dark) 100%);

            /* Shadows & Radii */
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;

            /* Transitions */
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-base);
            /* Changed */
            color: var(--text-secondary);
            /* Changed */
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            background-color: var(--bg-elevated);
            /* Changed */
            padding: 30px;
            border-radius: var(--radius-xl);
            /* Changed */
            box-shadow: var(--shadow-lg);
            /* Changed */
            width: 100%;
            max-width: 900px;
            position: relative;
            z-index: 10;
        }

        h2 {
            color: var(--color-primary);
            /* Changed */
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            /* Changed */
            padding-bottom: 15px;
        }

        button {
            background-color: var(--color-primary);
            /* Changed */
            color: var(--text-on-dark);
            /* Changed */
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-lg);
            /* Changed */
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.2s ease, filter 0.2s ease;
        }

        button:hover {
            background-color: var(--navy-dark);
            /* Changed */
        }

        button:disabled {
            background-color: var(--bg-muted);
            /* Changed */
            color: var(--text-muted);
            /* Added */
            cursor: not-allowed;
        }

        .logoutBtn {
            background-color: var(--color-error);
            /* Changed */
            margin-top: 15px;
        }

        .logoutBtn:hover {
            filter: brightness(90%);
            /* Changed */
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-primary);
            /* Added */
        }

        input[type="text"],
        input[type="date"],
        select,
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-medium);
            /* Changed */
            border-radius: var(--radius-lg);
            /* Changed */
            background-color: var(--bg-elevated);
            /* Changed */
            color: var(--text-primary);
            /* Changed */
            box-sizing: border-box;
        }

        input[type="file"] {
            padding: 3px;
        }

        input::file-selector-button {
            background-color: var(--color-primary);
            /* Changed */
            color: var(--text-on-dark);
            /* Changed */
            border: none;
            padding: 10px;
            border-radius: var(--radius-lg);
            /* Changed */
            cursor: pointer;
            margin-right: 10px;
            /* Added spacing */
        }

        input::file-selector-button:hover {
            background-color: var(--navy-dark);
            /* Changed */
        }

        #vertical-display {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--color-secondary);
            /* Changed */
            margin: 10px 0 0 0;
            padding: 10px;
            background-color: var(--bg-subtle);
            /* Changed */
            border-radius: var(--radius-lg);
            /* Changed */
            text-align: center;
        }

        /* Message Styles */
        .message {
            margin-top: 20px;
            padding: 10px 15px;
            /* Added padding */
            border-radius: var(--radius-lg);
            /* Changed */
            display: none;
            font-weight: 500;
            /* Added */
        }

        .message.error {
            background-color: var(--color-error-pale);
            /* Changed */
            color: var(--color-error);
            /* Changed */
            display: block;
        }

        .message.success {
            background-color: var(--green-pale);
            /* Changed */
            color: var(--green-dark);
            /* Changed */
            display: block;
        }

        .message.info {
            background-color: var(--color-info-pale);
            /* Changed */
            color: var(--navy-dark);
            /* Changed */
            display: block;
        }

        /* Manage Section Styles */
        .manage-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
            /* Changed */
        }

        #manage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-subtle);
            /* Changed */
            border-radius: var(--radius-lg);
            /* Changed */
        }

        .manage-item {
            background: var(--bg-elevated);
            /* Changed */
            border: 1px solid var(--border-light);
            /* Changed */
            border-radius: var(--radius-lg);
            /* Changed */
            padding: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            /* Changed */
            font-size: 0.9rem;
        }

        .manage-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius-lg);
            /* Changed */
            margin-bottom: 10px;
        }

        .manage-item strong {
            color: var(--color-primary);
            /* Changed */
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .manage-item span {
            color: var(--text-muted);
            /* Changed */
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .delete-btn {
            background-color: var(--color-error);
            /* Changed */
            color: var(--text-on-dark);
            /* Changed */
            font-size: 14px;
            padding: 8px 10px;
            margin-top: auto;
        }

        .delete-btn:hover {
            background-color: var(--color-error);
            /* Kept */
            filter: brightness(90%);
            /* Changed */
        }

        .delete-btn:disabled {
            background-color: var(--bg-muted);
            /* Changed */
            color: var(--text-muted);
            /* Added */
            cursor: not-allowed;
        }

        #manage-grid-loading {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            /* Changed */
        }

        /* === NEW CUSTOM MODAL STYLES === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: var(--bg-elevated);
            /* Changed */
            border: 1px solid var(--border-light);
            /* Changed */
            padding: 25px 30px;
            border-radius: var(--radius-xl);
            /* Changed */
            box-shadow: var(--shadow-xl);
            /* Changed */
            width: 100%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-box {
            transform: scale(1);
        }

        .modal-box h3 {
            color: var(--color-primary);
            /* Changed */
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.25rem;
        }

        .modal-box p {
            margin-bottom: 25px;
            color: var(--text-secondary);
            /* Changed */
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            width: auto;
            padding: 10px 20px;
            margin-top: 0;
        }

        .modal-btn-cancel {
            background-color: var(--text-muted);
            /* Changed */
            color: var(--text-on-dark);
            /* Added */
        }

        .modal-btn-cancel:hover {
            background-color: var(--text-secondary);
            /* Changed */
        }

        .modal-btn-confirm {
            background-color: var(--color-error);
            /* Changed */
            color: var(--text-on-dark);
            /* Added */
        }

        .modal-btn-confirm:hover {
            background-color: var(--color-error);
            /* Kept */
            filter: brightness(90%);
            /* Changed */
        }
    </style>
</head>

<body>

    <div class="container" id="upload-container" style="display: none;">
        <h2>Upload New Photo</h2>
        <form id="upload-form">
            <div class="form-group">
                <label for="vertical-select">Vertical:</label>
                <select id="vertical-select" required>
                    <option value="">Loading...</option>
                </select>
                <div id="vertical-display" style="display: none;"></div>
            </div>
            <div class="form-group">
                <label for="event-name">Event Name:</label>
                <input type="text" id="event-name" required>
            </div>
            <div class="form-group">
                <label for="event-date">Event Date:</label>
                <input type="date" id="event-date" required>
            </div>
            <div class="form-group">
                <label for="event-location">Event Location:</label>
                <input type="text" id="event-location" required>
            </div>
            <div class="form-group">
                <label for="image-file">Image (Max 500 KB):</label>
                <input type="file" id="image-file" accept="image/jpeg, image/png, image/webp" required>
            </div>
            <button type="submit" id="submit-btn">Upload Image</button>
        </form>
        <div id="message" class="message"></div>

        <div class="manage-section">
            <h2>Manage Existing Photos</h2>
            <div id="manage-grid">
                <div id="manage-grid-loading">Loading photos...</div>
            </div>
        </div>

        <button id="logoutBtn" class="logoutBtn">Logout</button>
    </div>

    <div class="modal-overlay" id="delete-modal">
        <div class="modal-box">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this photo? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn-cancel" id="modal-cancel-btn">Cancel</button>
                <button class="modal-btn-confirm" id="modal-confirm-btn">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // --- 1. Initialize Supabase ---
        const SUPABASE_URL = 'https://jgsrsjwmywiirtibofth.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_5KtvO0cEHfnECBoyp2CQnw_RC3_x2me';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- 2. DOM Elements ---
        const uploadContainer = document.getElementById('upload-container');
        const uploadForm = document.getElementById('upload-form');
        const verticalSelect = document.getElementById('vertical-select');
        const verticalSelectLabel = document.querySelector('label[for="vertical-select"]');
        const verticalDisplay = document.getElementById('vertical-display');
        const imageFile = document.getElementById('image-file');
        const submitBtn = document.getElementById('submit-btn');
        const messageDiv = document.getElementById('message');
        const logoutBtn = document.getElementById('logoutBtn');
        const manageGrid = document.getElementById('manage-grid');
        const manageGridLoading = document.getElementById('manage-grid-loading');

        // New Modal DOM Elements
        const deleteModal = document.getElementById('delete-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let currentUserEmail = '';
        let userVerticals = [];
        let itemToDelete = { id: null, path: null, btn: null }; // Store item to delete

        // --- 3. File Validation Constants ---
        const MAX_FILE_SIZE = 500 * 1024; // 500 KB
        const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
        const STORAGE_BUCKET = 'vertical_images';

        // --- 4. MAIN SCRIPT: ON PAGE LOAD ---
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'photo-upload.html';
                return;
            }
            currentUserEmail = session.user.email;
            uploadContainer.style.display = 'block';

            const { data: accessData, error: accessError } = await supabase
                .from('vertical_access')
                .select('vertical_name')
                .eq('email', currentUserEmail);

            if (accessError || !accessData || accessData.length === 0) {
                showMessage('Error fetching permissions or no verticals assigned.', 'error');
                submitBtn.disabled = true;
                return;
            }
            userVerticals = accessData.map(item => item.vertical_name);
            setupVerticalSelector(accessData);
            loadManagedPhotos(userVerticals);
        });

        // --- 5. SETUP VERTICAL SELECTOR ---
        function setupVerticalSelector(accessData) {
            if (accessData.length === 1) {
                const verticalName = accessData[0].vertical_name;
                verticalSelect.style.display = 'none';
                verticalDisplay.textContent = verticalName;
                verticalDisplay.style.display = 'block';
                verticalSelectLabel.textContent = 'Uploading for Vertical:';
                verticalSelect.innerHTML = `<option value="${verticalName}">${verticalName}</option>`;
                verticalSelect.value = verticalName;
            } else {
                verticalSelect.style.display = 'block';
                verticalDisplay.style.display = 'none';
                verticalSelectLabel.textContent = 'Select Vertical:';
                verticalSelect.innerHTML = '<option value="">-- Select a vertical --</option>';
                accessData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.vertical_name;
                    option.textContent = item.vertical_name;
                    verticalSelect.appendChild(option);
                });
            }
        }

        // --- 6. LOAD EXISTING PHOTOS ---
        async function loadManagedPhotos(verticalNames) {
            manageGridLoading.style.display = 'block';
            manageGrid.innerHTML = '';

            const { data, error } = await supabase
                .from('vertical_events')
                .select('id, event_name, event_date, image_url, vertical_name')
                .in('vertical_name', verticalNames)
                .order('created_at', { ascending: false });

            manageGridLoading.style.display = 'none';
            if (error) { manageGrid.innerHTML = '<p>Error loading photos.</p>'; return; }
            if (data.length === 0) { manageGrid.innerHTML = '<p>No photos uploaded yet.</p>'; return; }

            data.forEach(photo => {
                const item = createPhotoManageItem(photo);
                manageGrid.appendChild(item);
            });
        }

        // --- 7. CREATE HTML FOR A SINGLE PHOTO ITEM ---
        function createPhotoManageItem(photo) {
            const item = document.createElement('div');
            item.className = 'manage-item';
            item.id = `photo-item-${photo.id}`;
            const date = new Date(photo.event_date).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
            const url = new URL(photo.image_url);
            const imagePath = url.pathname.split(STORAGE_BUCKET + '/')[1];

            item.innerHTML = `
                <img src="${photo.image_url}" alt="${photo.event_name}">
                <strong>${photo.event_name}</strong>
                <span>${date}</span>
                <span>Vertical: ${photo.vertical_name}</span>
                <button class="delete-btn" data-id="${photo.id}" data-path="${imagePath}">Delete</button>
            `;
            return item;
        }

        // --- 8. HANDLE FORM SUBMISSION (UPLOAD) ---
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = imageFile.files[0];
            const eventName = document.getElementById('event-name').value;
            const eventDate = document.getElementById('event-date').value;
            const eventLocation = document.getElementById('event-location').value;
            const verticalName = verticalSelect.value;

            // Validation
            if (!file || !eventName || !eventDate || !eventLocation || !verticalName) {
                showMessage('All fields are required.', 'error'); return;
            }
            if (file.size > MAX_FILE_SIZE) {
                showMessage(`File is too large. Max is 500 KB.`, 'error'); return;
            }
            if (!ALLOWED_TYPES.includes(file.type)) {
                showMessage('Invalid file type. Only JPG, PNG, or WebP allowed.', 'error'); return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
            showMessage('Uploading file, please wait...', 'info');

            try {
                // 1. Upload to Storage
                const fileExt = file.name.split('.').pop();
                const fileName = `${verticalName}/${Date.now()}.${fileExt}`;
                const { data: uploadData, error: uploadError } = await supabase.storage.from(STORAGE_BUCKET).upload(fileName, file);
                if (uploadError) throw uploadError;

                // 2. Get Public URL
                const { data: publicUrlData } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(fileName);
                const imageUrl = publicUrlData.publicUrl;

                // 3. Insert into 'vertical_events' table
                const eventRecord = { event_name: eventName, event_date: eventDate, event_location: eventLocation, vertical_name: verticalName, image_url: imageUrl, uploaded_by: currentUserEmail };
                const { data: insertData, error: insertError } = await supabase.from('vertical_events').insert(eventRecord).select().single();
                if (insertError) throw new Error(`Database error: ${insertError.message}.`);

                // 4. Success
                showMessage('Upload successful! Image is now live.', 'success');
                uploadForm.reset();
                if (verticalSelect.style.display === 'none') { verticalSelect.value = verticalName; }

                // 5. Add new photo to the top of the management grid
                if (manageGrid.querySelector('p')) { manageGrid.innerHTML = ''; }
                const newItem = createPhotoManageItem(insertData);
                manageGrid.prepend(newItem);

            } catch (error) {
                console.error('Upload failed:', error);
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Image';
            }
        });

        // --- 9. HANDLE DELETE BUTTON CLICKS (Show Modal) ---
        manageGrid.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('delete-btn')) {
                const btn = e.target;
                const id = btn.getAttribute('data-id');
                const path = btn.getAttribute('data-path');

                // Store the details of the item to be deleted
                itemToDelete = { id, path, btn };

                // Show the modal
                deleteModal.classList.add('show');
            }
        });

        // --- 10. HANDLE MODAL CANCEL BUTTON ---
        modalCancelBtn.addEventListener('click', () => {
            deleteModal.classList.remove('show');
            // Clear the stored item
            itemToDelete = { id: null, path: null, btn: null };
        });

        // --- 11. HANDLE MODAL CONFIRM DELETE BUTTON ---
        modalConfirmBtn.addEventListener('click', async () => {
            const { id, path, btn } = itemToDelete;
            if (!id || !path || !btn) return; // Safety check

            btn.disabled = true;
            btn.textContent = 'Deleting...';
            modalConfirmBtn.disabled = true; // Disable confirm button

            try {
                // 1. Delete from Storage
                const { error: storageError } = await supabase.storage
                    .from(STORAGE_BUCKET)
                    .remove([path]);
                if (storageError) throw new Error(`Storage Error: ${storageError.message}`);

                // 2. Delete from Database
                const { error: dbError } = await supabase
                    .from('vertical_events')
                    .delete()
                    .eq('id', id);
                if (dbError) throw new Error(`Database Error: ${dbError.message}`);

                // 3. Remove from UI
                document.getElementById(`photo-item-${id}`).remove();
                showMessage('Photo deleted successfully.', 'success');

                if (manageGrid.children.length === 0) {
                    manageGrid.innerHTML = '<p>No photos uploaded yet.</p>';
                }

            } catch (error) {
                console.error('Delete failed:', error);
                showMessage(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'Delete';
            } finally {
                // Hide modal and clear item
                deleteModal.classList.remove('show');
                itemToDelete = { id: null, path: null, btn: null };
                modalConfirmBtn.disabled = false; // Re-enable confirm button
            }
        });

        // --- 12. LOGOUT BUTTON ---
        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'photo-upload.html';
        });

        // --- Helper function ---
        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `message ${type}`;
            // Auto-hide success/info messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 4000);
            }
        }
    </script>
</body>

</html>