<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Photo Upload Access</title>
    <link rel="shortcut icon" href="/Images/YUVA logo.png" type="image/x-icon">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> -->
    <style>
        /* Add the root variables at the top */
        :root {
            /* India Theme Color Palette */
            --saffron-primary: #FF9933;
            --saffron-light: #FFB366;
            --saffron-dark: #E67300;
            --saffron-pale: #FFE5CC;
            --white-primary: #FFFFFF;
            --white-warm: #FAFAF9;
            --white-cream: #F5F5F4;
            --green-primary: #138808;
            --green-light: #22C55E;
            --green-dark: #0F6606;
            --green-pale: #D1FAE5;
            --navy-chakra: #000080;
            --navy-dark: #00005C;

            /* Semantic Colors */
            --color-primary: var(--navy-chakra);
            --color-secondary: var(--green-primary);
            --color-accent: var(--saffron-primary);
            --color-error: #ef4444;
            --color-error-pale: #fef2f2;
            --color-info-pale: #EBF4FF;

            /* Text & Background */
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-muted: #64748B;
            --text-on-dark: var(--white-primary);
            --text-on-accent: var(--white-primary);
            --bg-base: var(--white-warm);
            --bg-elevated: var(--white-primary);
            --bg-subtle: var(--white-cream);
            --bg-muted: #F1F5F9;
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;

            /* Gradients */
            --gradient-hero: linear-gradient(135deg, var(--saffron-light) 0%, var(--white-primary) 50%, var(--green-light) 100%);
            --gradient-saffron: linear-gradient(135deg, var(--saffron-primary) 0%, var(--saffron-dark) 100%);
            --gradient-green: linear-gradient(135deg, var(--green-light) 0%, var(--green-primary) 100%);
            --gradient-navy: linear-gradient(135deg, var(--navy-chakra) 0%, var(--navy-dark) 100%);

            /* Shadows & Radii */
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;

            /* Transitions */
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-base);
            color: var(--text-secondary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: var(--bg-elevated);
            padding: 30px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        h2 {
            color: var(--color-primary);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-primary);
        }

        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-lg);
            background-color: var(--bg-elevated);
            color: var(--text-primary);
            box-sizing: border-box;
        }

        button {
            background-color: var(--color-primary);
            color: var(--text-on-dark);
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: var(--navy-dark);
        }

        .message {
            margin-top: 20px;
            padding: 10px 15px;
            border-radius: var(--radius-lg);
            display: none;
            font-weight: 500;
        }

        .message.error {
            background-color: var(--color-error-pale);
            color: var(--color-error);
            display: block;
        }

        .message.success {
            background-color: var(--green-pale);
            color: var(--green-dark);
            display: block;
        }

        .message.info {
            background-color: var(--color-info-pale);
            color: var(--navy-dark);
            display: block;
        }

        /* --- NEW STYLE FOR FORGOT PASSWORD LINK --- */
        .forgot-password {
            text-align: right;
            margin-top: 10px;
        }

        .forgot-password a {
            font-size: 0.9rem;
            color: var(--color-primary);
            text-decoration: none;
            cursor: pointer;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Secure Access</h2>

        <div id="emailVerificationSection">
            <div class="form-group">
                <label for="email">Enter your authorized email:</label>
                <input type="email" id="email" placeholder="your@example.com" required>
            </div>
            <button id="verifyEmailBtn">Verify Email</button>
        </div>

        <div id="passwordSection" style="display: none;">
            <div class="form-group">
                <label for="password">Enter your password:</label>
                <input type="password" id="password" placeholder="********" required>
            </div>

            <div class="form-group forgot-password">
                <a id="forgotPasswordLink">Forgot Password?</a>
            </div>
            <button id="loginBtn">Login</button>
        </div>

        <div id="securityKeySection" style="display: none;">
            <div class="form-group">
                <label for="securityKey">Enter your security key:</label>
                <input type="password" id="securityKey" placeholder="********" required>
            </div>
            <button id="verifySecurityKeyBtn">Verify Security Key</button>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- 1. Initialize Supabase ---
        const SUPABASE_URL = 'https://jgsrsjwmywiirtibofth.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_5KtvO0cEHfnECBoyp2CQnw_RC3_x2me';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- 2. Get DOM Elements ---
        const emailInput = document.getElementById('email');
        const verifyEmailBtn = document.getElementById('verifyEmailBtn');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const securityKeyInput = document.getElementById('securityKey');
        const verifySecurityKeyBtn = document.getElementById('verifySecurityKeyBtn');

        const emailVerificationSection = document.getElementById('emailVerificationSection');
        const passwordSection = document.getElementById('passwordSection');
        const securityKeySection = document.getElementById('securityKeySection');
        const messageDiv = document.getElementById('message');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');

        let verifiedEmail = ''; // Store the email

        // --- 3. Step 1: Verify Email ---
        verifyEmailBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            if (!email) {
                showMessage('Please enter an email address.', 'error'); return;
            }
            showMessage('Verifying email...', 'info');
            const { data: is_authorized, error: rpcError } = await supabase
                .rpc('check_vertical_admin', { user_email: email });

            if (rpcError) {
                console.error('Error checking email:', rpcError);
                showMessage('Error during email verification.', 'error');
                return;
            }
            if (is_authorized) {
                verifiedEmail = email;
                emailVerificationSection.style.display = 'none';
                passwordSection.style.display = 'block';
                showMessage('Email verified! Please enter your password.', 'success');
            } else {
                showMessage('Email not authorized for uploads.', 'error');
            }
        });

        // --- 4. Step 2: Login with Password ---
        loginBtn.addEventListener('click', async () => {
            const password = passwordInput.value;
            if (!password) {
                showMessage('Please enter your password.', 'error'); return;
            }
            showMessage('Logging in...', 'info');
            const { data, error } = await supabase.auth.signInWithPassword({
                email: verifiedEmail,
                password: password,
            });

            if (error) {
                console.error('Login error:', error);
                showMessage('Login failed. Please check your password.', 'error');
                return;
            }
            if (data.session) {
                passwordSection.style.display = 'none';
                securityKeySection.style.display = 'block';
                showMessage('Login successful! Please enter your security key.', 'success');
            }
        });

        // --- 5. Handle Forgot Password Click (UPDATED) ---
        forgotPasswordLink.addEventListener('click', async () => {
            if (!verifiedEmail) {
                showMessage('Please verify your email address first.', 'error');
                return;
            }

            showMessage('Sending password reset link...', 'info');

            // ** THIS IS THE CHANGE **
            // We now tell Supabase to redirect to 'password-reset.html'
            // NEW CORRECT LINE
            const redirectURL = window.location.origin + '/OurVerticals/password-reset.html';

            const { data, error } = await supabase.auth.resetPasswordForEmail(verifiedEmail, {
                redirectTo: redirectURL,
            });

            if (error) {
                console.error('Error sending reset link:', error);
                showMessage(`Error: ${error.message}`, 'error');
            } else {
                showMessage('Password reset link sent to your email!', 'success');
            }
        });

        // --- 6. Step 3: Verify Security Key ---
        verifySecurityKeyBtn.addEventListener('click', async () => {
            const securityKey = securityKeyInput.value.trim();
            if (!securityKey) {
                showMessage('Please enter your security key.', 'error'); return;
            }
            showMessage('Verifying security key...', 'info');
            const { data, error } = await supabase
                .from('security_keys')
                .select('id')
                .eq('email', verifiedEmail)
                .eq('security_key', securityKey);

            if (error) {
                console.error('Error verifying security key:', error);
                showMessage('Error during key verification.', 'error');
                return;
            }
            if (data && data.length > 0) {
                window.location.href = 'upload-form.html';
            } else {
                showMessage('Invalid security key.', 'error');
            }
        });

        // --- Helper function ---
        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `message ${type}`;
        }
    </script>
</body>

</html>