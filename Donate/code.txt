/**
 * YUVA - Youth United for Vision and Action Donation System - Google Apps Script Backend
 * This script handles donation processing, Razorpay integration, and data storage
 */

// function createCorsResponse(data) {
//   return ContentService.createTextOutput(JSON.stringify(data))
//     .setMimeType(ContentService.MimeType.JSON);
// }

/**
 * Create response with CORS headers
 */
function createCorsResponse(data) {
  const response = ContentService.createTextOutput(JSON.stringify(data));
  response.setMimeType(ContentService.MimeType.JSON);

  // Google Apps Script doesn't support setHeader, but automatically handles CORS
  // for web apps when deployed with proper permissions
  return response;
}
// Configuration - Replace with your actual values
const CONFIG = {
  RAZORPAY_KEY_ID: 'rzp_test_RCnv6goa4rkg0Q', // Replace with your Razorpay Key ID
  RAZORPAY_KEY_SECRET: 'qRw549IUqi47RQjbTf1d0clN', // Replace with your Razorpay Key Secret
  SHEET_ID: '1y1ddw7DXgVDRAr6sXTCs16QY48XDBCKY3DSOLBbZkwI', // Replace with your Google Sheet ID
  SHEET_NAME: 'Donations', // Name of the sheet tab
  WEBHOOK_SECRET: 'your_webhook_secret_here' // For webhook verification
};

/**
 * Initialize the Google Sheet with headers if it doesn't exist
 * This function runs automatically when the script is first executed
 */
function initializeSheet() {
  try {
    // Directly access the sheet without calling getSheet() to avoid loop
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    let sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);

    // Create sheet if it doesn't exist
    if (!sheet) {
      console.log('Creating new sheet:', CONFIG.SHEET_NAME);
      sheet = spreadsheet.insertSheet(CONFIG.SHEET_NAME);
    }

    // Check if sheet is empty or headers don't exist
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();

    // If sheet is completely empty or has no headers
    if (lastRow === 0 || lastCol === 0 || sheet.getRange(1, 1).getValue() === '') {
      console.log('Initializing sheet with headers...');

      const headerRow = [
        'Timestamp',
        'Donor Name',
        'Email',
        'Phone',
        'City',
        'Amount',
        'Donation Type',
        'Payment ID',
        'Order ID',
        'Signature',
        'Status',
        'Subscription ID',
        'Notes'
      ];

      // Set headers in first row
      sheet.getRange(1, 1, 1, headerRow.length).setValues([headerRow]);

      // Format header row
      const headerRange = sheet.getRange(1, 1, 1, headerRow.length);
      headerRange.setFontWeight('bold');
      headerRange.setBackground('#555879');
      headerRange.setFontColor('white');
      headerRange.setHorizontalAlignment('center');

      // Set column widths for better readability
      sheet.setColumnWidth(1, 150); // Timestamp
      sheet.setColumnWidth(2, 200); // Donor Name
      sheet.setColumnWidth(3, 250); // Email
      sheet.setColumnWidth(4, 120); // Phone
      sheet.setColumnWidth(5, 150); // City
      sheet.setColumnWidth(6, 100); // Amount
      sheet.setColumnWidth(7, 120); // Donation Type
      sheet.setColumnWidth(8, 200); // Payment ID
      sheet.setColumnWidth(9, 200); // Order ID
      sheet.setColumnWidth(10, 200); // Signature
      sheet.setColumnWidth(11, 100); // Status
      sheet.setColumnWidth(12, 200); // Subscription ID
      sheet.setColumnWidth(13, 300); // Notes

      // Freeze the header row
      sheet.setFrozenRows(1);

      console.log('Sheet initialized successfully with headers');
    } else {
      console.log('Sheet already has headers, skipping initialization');
    }

    return true;
  } catch (error) {
    console.error('Error initializing sheet:', error);
    return false;
  }
}

/**
 * Get the Google Sheet and auto-initialize if needed
 */
function getSheet() {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    let sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);

    // Create sheet if it doesn't exist
    if (!sheet) {
      console.log('Creating new sheet:', CONFIG.SHEET_NAME);
      sheet = spreadsheet.insertSheet(CONFIG.SHEET_NAME);
    }

    // Auto-initialize headers if sheet is empty (without calling initializeSheet to avoid loop)
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();

    if (lastRow === 0 || lastCol === 0 || sheet.getRange(1, 1).getValue() === '') {
      console.log('Auto-initializing sheet headers...');

      const headerRow = [
        'Timestamp',
        'Donor Name',
        'Email',
        'Phone',
        'City',
        'Amount',
        'Donation Type',
        'Payment ID',
        'Order ID',
        'Signature',
        'Status',
        'Subscription ID',
        'Notes'
      ];

      // Set headers in first row
      sheet.getRange(1, 1, 1, headerRow.length).setValues([headerRow]);

      // Format header row
      const headerRange = sheet.getRange(1, 1, 1, headerRow.length);
      headerRange.setFontWeight('bold');
      headerRange.setBackground('#555879');
      headerRange.setFontColor('white');
      headerRange.setHorizontalAlignment('center');

      // Set column widths for better readability
      sheet.setColumnWidth(1, 150); // Timestamp
      sheet.setColumnWidth(2, 200); // Donor Name
      sheet.setColumnWidth(3, 250); // Email
      sheet.setColumnWidth(4, 120); // Phone
      sheet.setColumnWidth(5, 150); // City
      sheet.setColumnWidth(6, 100); // Amount
      sheet.setColumnWidth(7, 120); // Donation Type
      sheet.setColumnWidth(8, 200); // Payment ID
      sheet.setColumnWidth(9, 200); // Order ID
      sheet.setColumnWidth(10, 200); // Signature
      sheet.setColumnWidth(11, 100); // Status
      sheet.setColumnWidth(12, 200); // Subscription ID
      sheet.setColumnWidth(13, 300); // Notes

      // Freeze the header row
      sheet.setFrozenRows(1);

      console.log('Sheet initialized successfully with headers');
    }

    return sheet;
  } catch (error) {
    console.error('Error accessing sheet:', error);
    throw new Error('Unable to access Google Sheet. Please check your SHEET_ID configuration.');
  }
}

/**
 * Create Razorpay order
 */
function createOrder(request) {
  try {
    let data;

    // Handle both form data and JSON data
    if (request.postData && request.postData.contents) {
      data = JSON.parse(request.postData.contents);
    } else {
      data = request.parameter;
    }

    const { amount, currency = 'INR', receipt } = data;

    if (!amount || amount < 1) {
      return {
        success: false,
        error: 'Invalid amount'
      };
    }

    const orderData = {
      amount: Math.round(amount * 100), // Convert to paise
      currency: currency,
      receipt: receipt || `receipt_${Date.now()}`,
      notes: {
        source: 'YUVA - Youth United for Vision and Action Website'
      }
    };

    const response = createRazorpayOrder(orderData);

    if (response.error) {
      return {
        success: false,
        error: response.error.description || 'Failed to create order'
      };
    }

    return {
      success: true,
      order: {
        id: response.id,
        amount: response.amount,
        currency: response.currency,
        receipt: response.receipt
      }
    };

  } catch (error) {
    console.error('Error creating order:', error);
    return {
      success: false,
      error: 'Internal server error'
    };
  }
}

/**
 * Verify Razorpay payment
 */
/**
 * Verify Razorpay payment - CORRECTED VERSION
 */
/**
 * Verify Razorpay payment - CORRECTED VERSION
 */
function verifyPayment(request) {
  try {
    let data;
    if (request.postData && request.postData.contents) {
      data = JSON.parse(request.postData.contents);
    } else {
      data = request.parameter;
    }

    const { razorpay_order_id, razorpay_payment_id, razorpay_signature } = data;

    if (!razorpay_order_id || !razorpay_payment_id || !razorpay_signature) {
      return { success: false, error: 'Missing payment verification data' };
    }

    // This is the corrected signature generation logic
    const body = razorpay_order_id + '|' + razorpay_payment_id;
    const signatureBytes = Utilities.computeHmacSha256Signature(body, CONFIG.RAZORPAY_KEY_SECRET);

    // Convert the generated signature bytes to a hex string for comparison
    let signatureHex = '';
    for (let i = 0; i < signatureBytes.length; i++) {
      let byte = signatureBytes[i];
      if (byte < 0) {
        byte += 256;
      }
      const byteHex = byte.toString(16);
      signatureHex += (byteHex.length === 1 ? '0' : '') + byteHex;
    }

    // Compare our generated signature with the one from Razorpay
    const isValid = signatureHex === razorpay_signature;

    if (!isValid) {
      return { success: false, error: 'Invalid signature' };
    }

    return { success: true, message: 'Payment verified successfully' };

  } catch (error) {
    console.error('Error verifying payment:', error);
    return { success: false, error: 'Payment verification failed' };
  }
}

/**
 * Save donation data to Google Sheet
 */
function saveDonation(request) {
  try {
    console.log('saveDonation called with request:', request);

    const data = JSON.parse(request.postData.contents);
    console.log('Parsed data:', data);

    const {
      name,
      email,
      phone,
      city,
      amount,
      isRecurring,
      paymentId,
      orderId,
      signature,
      subscriptionId
    } = data;

    // Validate required fields
    if (!name || !email || !phone || !city || !amount || !paymentId) {
      console.error('Missing required fields:', { name, email, phone, city, amount, paymentId });
      return {
        success: false,
        error: 'Missing required donation data'
      };
    }

    console.log('All required fields present, accessing sheet...');

    // Get sheet (auto-initializes if needed)
    const sheet = getSheet();
    console.log('Sheet accessed successfully:', sheet.getName());

    // Prepare row data
    const rowData = [
      new Date(), // Timestamp
      name,
      email,
      phone,
      city,
      amount,
      isRecurring ? 'Recurring' : 'One-time',
      paymentId,
      orderId || '',
      signature || '',
      'Completed',
      subscriptionId || '',
      'Donation processed successfully'
    ];

    console.log('Prepared row data:', rowData);

    // Add data to sheet
    sheet.appendRow(rowData);
    console.log('Data appended to sheet successfully');

    // Send confirmation email (optional)
    try {
      sendConfirmationEmail(data);
      console.log('Confirmation email sent');
    } catch (emailError) {
      console.error('Email sending failed:', emailError);
      // Don't fail the whole process if email fails
    }

    return {
      success: true,
      message: 'Donation data saved successfully'
    };

  } catch (error) {
    console.error('Error saving donation:', error);
    return {
      success: false,
      error: 'Failed to save donation data: ' + error.toString()
    };
  }
}

/**
 * Create Razorpay order via API
 */
function createRazorpayOrder(orderData) {
  const url = 'https://api.razorpay.com/v1/orders';

  const options = {
    method: 'POST',
    headers: {
      'Authorization': 'Basic ' + Utilities.base64Encode(CONFIG.RAZORPAY_KEY_ID + ':' + CONFIG.RAZORPAY_KEY_SECRET),
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify(orderData)
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const responseData = JSON.parse(response.getContentText());

    if (response.getResponseCode() !== 200) {
      throw new Error(responseData.error?.description || 'Failed to create order');
    }

    return responseData;
  } catch (error) {
    console.error('Razorpay API Error:', error);
    return { error: error };
  }
}

/**
 * Generate shared email template with common styling
 */
function generateEmailTemplate(headerColor, title, content) {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>${title}</title>
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        
        body {
          font-family: 'Inter', Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          background: #f8fafc;
        }
        
        .email-container {
          max-width: 600px;
          margin: 0 auto;
          background: #ffffff;
          border-radius: 16px;
          overflow: hidden;
          box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .email-header {
          background: linear-gradient(135deg, #555879, #98A1BC);
          padding: 40px 30px;
          text-align: center;
          position: relative;
          overflow: hidden;
        }
        
        .email-header::before {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
          animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
          0%, 100% { transform: rotate(0deg); }
          50% { transform: rotate(180deg); }
        }
        
        .logo {
          height: 80px;
          margin-bottom: 20px;
          position: relative;
          z-index: 2;
          filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }
        
        .header-title {
          color: white;
          font-size: 28px;
          font-weight: 800;
          margin: 0;
          position: relative;
          z-index: 2;
          text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .email-content {
          padding: 40px 30px;
          background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .content-card {
          background: white;
          border-radius: 12px;
          padding: 30px;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          margin-bottom: 30px;
        }
        
        .highlight-box {
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
          border: 2px solid #f59e0b;
          border-radius: 12px;
          padding: 20px;
          margin: 20px 0;
          text-align: center;
        }
        
        .amount-display {
          font-size: 32px;
          font-weight: 800;
          color: #059669;
          margin: 10px 0;
        }
        
        .whatsapp-section {
          text-align: center;
          margin: 30px 0;
          padding: 30px;
          background: linear-gradient(135deg, #f8f9ff 0%, #e8eaff 100%);
          border-radius: 12px;
          border: 2px solid #555879;
        }
        
        .whatsapp-button {
          display: inline-block;
          background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
          color: white;
          text-decoration: none;
          padding: 16px 32px;
          border-radius: 50px;
          font-weight: 700;
          font-size: 16px;
          box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
          transition: all 0.3s ease;
          margin: 10px 0;
          position: relative;
          overflow: hidden;
        }
        
        .whatsapp-button::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s;
        }
        
        .whatsapp-button:hover::before {
          left: 100%;
        }
        
        .impact-stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 20px;
          margin: 30px 0;
        }
        
        .stat-item {
          text-align: center;
          padding: 20px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-number {
          font-size: 24px;
          font-weight: 800;
          color: #555879;
          display: block;
        }
        
        .stat-label {
          font-size: 14px;
          color: #6b7280;
          margin-top: 5px;
        }
        
        .footer {
          text-align: center;
          padding: 30px;
          background: linear-gradient(135deg, #555879 0%, #3a3f5c 100%);
          color: white;
        }
        
        .footer-title {
          font-size: 20px;
          font-weight: 700;
          margin-bottom: 10px;
        }
        
        .footer-subtitle {
          color: #9ca3af;
          font-size: 14px;
        }
        
        .social-links {
          margin: 20px 0;
        }
        
        .social-link {
          display: inline-block;
          margin: 0 10px;
          color: #9ca3af;
          text-decoration: none;
          font-size: 14px;
        }
        
        @media only screen and (max-width: 600px) {
          .email-container {
            margin: 10px;
            border-radius: 12px;
          }
          
          .email-header {
            padding: 30px 20px;
          }
          
          .email-content {
            padding: 30px 20px;
          }
          
          .content-card {
            padding: 20px;
          }
          
          .header-title {
            font-size: 24px;
          }
          
          .amount-display {
            font-size: 28px;
          }
          
          .impact-stats {
            grid-template-columns: 1fr;
          }
        }
      </style>
    </head>
    <body>
      <div class="email-container">
        <div class="email-header">
          <img src="https://yuva.ind.in/Images/YUVA%20logo.png" alt="YUVA Logo" class="logo">
          <h1 class="header-title">${title}</h1>
        </div>
        
        <div class="email-content">
          <div class="content-card">
            ${content}
          </div>
          
          <div class="impact-stats">
            <div class="stat-item">
              <span class="stat-number">10,000+</span>
              <span class="stat-label">Students Helped</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">500+</span>
              <span class="stat-label">Events Organized</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">50+</span>
              <span class="stat-label">Cities Covered</span>
            </div>
          </div>
          
          <div class="whatsapp-section">
            <h3 style="color: #555879; margin-bottom: 15px;">ðŸ“± Stay Connected with YUVA</h3>
            <a href="https://whatsapp.com/channel/0029Vb6mApvDzgTCSKtAAb2y" class="whatsapp-button">
              Follow Our WhatsApp Channel
            </a>
            <p style="color: #6b7280; font-size: 14px; margin-top: 15px;">
              Get real-time updates about our activities, events, and initiatives
            </p>
          </div>
        </div>
        
        <div class="footer">
          <div class="footer-title">YUVA - Youth United for Vision and Action</div>
          <div class="footer-subtitle">Empowering Youth, Building Tomorrow</div>

          <div class="social-links">
            <a href="https://www.facebook.com/YouthUnitedForVisionAndAction/" target="_blank">
              <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/facebook.svg" alt="Facebook" width="24" height="24" style="filter: invert(89%) sepia(13%) saturate(254%) hue-rotate(343deg) brightness(96%) contrast(91%); margin: 0 8px;">
            </a>
            <a href="https://www.instagram.com/yuvaofficialpage/" target="_blank">
              <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram" width="24" height="24" style="filter: invert(89%) sepia(13%) saturate(254%) hue-rotate(343deg) brightness(96%) contrast(91%); margin: 0 8px;">
            </a>
            <a href="https://twitter.com/yuva_delhi_?lang=en" target="_blank">
              <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/twitter.svg" alt="Twitter" width="24" height="24" style="filter: invert(89%) sepia(13%) saturate(254%) hue-rotate(343deg) brightness(96%) contrast(91%); margin: 0 8px;">
            </a>
            <a href="https://t.me/+6wUzrCHiXTAxYzll" target="_blank">
              <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/telegram.svg" alt="Telegram" width="24" height="24" style="filter: invert(89%) sepia(13%) saturate(254%) hue-rotate(343deg) brightness(96%) contrast(91%); margin: 0 8px;">
            </a>
            <a href="https://www.linkedin.com/company/youthunitedforvisionandaction?originalSubdomain=in" target="_blank">
              <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linkedin.svg" alt="LinkedIn" width="24" height="24" style="filter: invert(89%) sepia(13%) saturate(254%) hue-rotate(343deg) brightness(96%) contrast(91%); margin: 0 8px;">
            </a>
          </div>
        </div>

      </div>
    </body>
    </html>
  `;
}

/**
 * Send confirmation email to donor
 */
function sendConfirmationEmail(donationData) {
  try {
    const { name, email, amount, isRecurring } = donationData;

    const subject = `Thank you for your donation to YUVA - Youth United for Vision and Action - â‚¹${amount}`;

    const content = `
      <h2 style="color: #555879;">Dear ${name},</h2>
      
      <p>Thank you for your generous donation of <strong>â‚¹${amount}</strong> to YUVA - Youth United for Vision and Action!</p>
      
      <p>Your ${isRecurring ? 'monthly recurring' : 'one-time'} donation will help us:</p>
      <ul>
        <li>Support thousands of students across India</li>
        <li>Organize educational events and workshops</li>
        <li>Develop innovative programs for youth empowerment</li>
        <li>Create opportunities for community development</li>
      </ul>
      
      <div style="background: white; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
        <h3 style="color: #555879; margin-top: 0;">Donation Details</h3>
        <p><strong>Amount:</strong> â‚¹${amount}</p>
        <p><strong>Type:</strong> ${isRecurring ? 'Monthly Recurring' : 'One-time'}</p>
        <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-IN')}</p>
        <p><strong>Payment ID:</strong> ${donationData.paymentId}</p>
      </div>
      
      <p>We will send you regular updates about how your donation is making a difference in the lives of young people across India.</p>
      
      <p>If you have any questions, please don't hesitate to contact us.</p>
    `;

    const htmlBody = generateEmailTemplate('#555879, #98A1BC', 'Thank You!', content);

    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: "YUVA - Youth United for Vision and Action"
    });

  } catch (error) {
    console.error('Error sending confirmation email:', error);
    // Don't fail the donation process if email fails
  }
}

/**
 * Send payment failure email to donor
 */
function sendPaymentFailureEmail(donationData, errorReason) {
  try {
    const { name, email, amount, isRecurring } = donationData;

    const subject = `Payment Failed - YUVA - Youth United for Vision and Action Donation`;

    const content = `
      <h2 style="color: #555879;">Dear ${name},</h2>
      
      <p>We encountered an issue processing your donation of <strong>â‚¹${amount}</strong> to YUVA - Youth United for Vision and Action.</p>
      
      <div style="background: #fee2e2; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid #ef4444;">
        <h3 style="color: #dc2626; margin-top: 0;">Payment Details</h3>
        <p><strong>Amount:</strong> â‚¹${amount}</p>
        <p><strong>Type:</strong> ${isRecurring ? 'Monthly Recurring' : 'One-time'}</p>
        <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-IN')}</p>
        <p><strong>Reason:</strong> ${errorReason || 'Payment processing failed'}</p>
      </div>
      
      <p><strong>What you can do:</strong></p>
      <ul>
        <li>Check your payment method details</li>
        <li>Ensure sufficient funds are available</li>
        <li>Try the donation process again</li>
        <li>Contact your bank if the issue persists</li>
      </ul>
      
      <p>We appreciate your intention to support our cause. Please don't hesitate to try again or contact us if you need assistance.</p>
    `;

    const htmlBody = generateEmailTemplate('#ef4444, #dc2626', 'Payment Failed', content);

    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: "YUVA - Youth United for Vision and Action"
    });

  } catch (error) {
    console.error('Error sending payment failure email:', error);
  }
}

/**
 * Send payment verification failure email to donor
 */
function sendVerificationFailureEmail(donationData) {
  try {
    const { name, email, amount, isRecurring } = donationData;

    const subject = `Payment Verification Failed - YUVA - Youth United for Vision and Action`;

    const content = `
      <h2 style="color: #555879;">Dear ${name},</h2>
      
      <p>We're having trouble verifying your payment of <strong>â‚¹${amount}</strong> to YUVA - Youth United for Vision and Action.</p>
      
      <div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid #f59e0b;">
        <h3 style="color: #d97706; margin-top: 0;">Payment Details</h3>
        <p><strong>Amount:</strong> â‚¹${amount}</p>
        <p><strong>Type:</strong> ${isRecurring ? 'Monthly Recurring' : 'One-time'}</p>
        <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-IN')}</p>
        <p><strong>Status:</strong> Verification Pending</p>
      </div>
      
      <p><strong>What this means:</strong></p>
      <ul>
        <li>Your payment may have been processed by your bank</li>
        <li>We're unable to verify it on our end</li>
        <li>This could be a temporary technical issue</li>
        <li>We're investigating the matter</li>
      </ul>
      
      <p><strong>Next steps:</strong></p>
      <ul>
        <li>Check your bank statement for the transaction</li>
        <li>Contact us if you see a charge but no confirmation</li>
        <li>We'll resolve this within 24-48 hours</li>
        <li>You'll receive an update once resolved</li>
      </ul>
      
      <p>We apologize for any inconvenience and appreciate your patience.</p>
    `;

    const htmlBody = generateEmailTemplate('#f59e0b, #d97706', 'Verification Issue', content);

    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: "YUVA - Youth United for Vision and Action"
    });

  } catch (error) {
    console.error('Error sending verification failure email:', error);
  }
}

/**
 * Send subscription failure email to donor
 */
function sendSubscriptionFailureEmail(donationData, errorReason) {
  try {
    const { name, email, amount } = donationData;

    const subject = `Monthly Donation Setup Failed - YUVA - Youth United for Vision and Action`;

    const content = `
      <h2 style="color: #555879;">Dear ${name},</h2>
      
      <p>We encountered an issue setting up your monthly donation of <strong>â‚¹${amount}</strong> to YUVA - Youth United for Vision and Action.</p>
      
      <div style="background: #fee2e2; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid #ef4444;">
        <h3 style="color: #dc2626; margin-top: 0;">Subscription Details</h3>
        <p><strong>Amount:</strong> â‚¹${amount} per month</p>
        <p><strong>Type:</strong> Monthly Recurring</p>
        <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-IN')}</p>
        <p><strong>Reason:</strong> ${errorReason || 'Subscription setup failed'}</p>
      </div>
      
      <p><strong>What you can do:</strong></p>
      <ul>
        <li>Try setting up the monthly donation again</li>
        <li>Consider making a one-time donation instead</li>
        <li>Contact us for assistance with recurring payments</li>
        <li>Check your payment method details</li>
      </ul>
      
      <p>We appreciate your commitment to supporting our cause regularly. Please don't hesitate to try again or contact us for help.</p>
    `;

    const htmlBody = generateEmailTemplate('#ef4444, #dc2626', 'Subscription Failed', content);

    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody,
      name: "YUVA - Youth United for Vision and Action"
    });

  } catch (error) {
    console.error('Error sending subscription failure email:', error);
  }
}

/**
 * Get donation statistics
 */
function getDonationStats(request) {
  try {
    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();

    if (data.length <= 1) {
      return {
        success: true,
        stats: {
          totalDonations: 0,
          totalAmount: 0,
          monthlyDonations: 0,
          oneTimeDonations: 0
        }
      };
    }

    // Skip header row
    const donations = data.slice(1);

    let totalAmount = 0;
    let monthlyCount = 0;
    let oneTimeCount = 0;

    donations.forEach(row => {
      if (row[5]) { // Amount column
        totalAmount += parseFloat(row[5]) || 0;
      }

      if (row[6]) { // Donation type column
        if (row[6] === 'Recurring') {
          monthlyCount++;
        } else {
          oneTimeCount++;
        }
      }
    });

    return {
      success: true,
      stats: {
        totalDonations: donations.length,
        totalAmount: totalAmount,
        monthlyDonations: monthlyCount,
        oneTimeDonations: oneTimeCount
      }
    };

  } catch (error) {
    console.error('Error getting donation stats:', error);
    return {
      success: false,
      error: 'Failed to retrieve statistics'
    };
  }
}

/**
 * Handle webhook from Razorpay
 */
function handleWebhook(request) {
  try {
    const body = request.postData.contents;
    const signature = request.headers['X-Razorpay-Signature'];

    // Verify webhook signature
    const expectedSignature = Utilities.computeHmacSha256Signature(body, CONFIG.WEBHOOK_SECRET);
    const actualSignature = Utilities.base64Decode(signature);

    const isValid = Utilities.computeHmacSha256Signature(expectedSignature, CONFIG.WEBHOOK_SECRET).toString() ===
      Utilities.computeHmacSha256Signature(actualSignature, CONFIG.WEBHOOK_SECRET).toString();

    if (!isValid) {
      return {
        success: false,
        error: 'Invalid webhook signature'
      };
    }

    const webhookData = JSON.parse(body);

    // Handle different webhook events
    switch (webhookData.event) {
      case 'payment.captured':
        handlePaymentCaptured(webhookData.payload.payment.entity);
        break;
      case 'subscription.charged':
        handleSubscriptionCharged(webhookData.payload.subscription.entity);
        break;
      default:
        console.log('Unhandled webhook event:', webhookData.event);
    }

    return {
      success: true,
      message: 'Webhook processed successfully'
    };

  } catch (error) {
    console.error('Error handling webhook:', error);
    return {
      success: false,
      error: 'Webhook processing failed'
    };
  }
}

/**
 * Handle payment captured webhook
 */
function handlePaymentCaptured(payment) {
  // Update payment status in sheet if needed
  console.log('Payment captured:', payment.id);
}

/**
 * Handle subscription charged webhook
 */
function handleSubscriptionCharged(subscription) {
  // Handle recurring payment
  console.log('Subscription charged:', subscription.id);
}

/**
 * Handle payment failure
 */
function handlePaymentFailure(request) {
  try {
    const data = JSON.parse(request.postData.contents);
    const { name, email, amount, isRecurring, errorReason } = data;

    // Send failure email
    sendPaymentFailureEmail({
      name,
      email,
      amount,
      isRecurring
    }, errorReason);

    // Log the failure
    console.log('Payment failure handled for:', email, 'Amount:', amount);

    return {
      success: true,
      message: 'Payment failure email sent successfully'
    };

  } catch (error) {
    console.error('Error handling payment failure:', error);
    return {
      success: false,
      error: 'Failed to handle payment failure'
    };
  }
}

/**
 * Handle verification failure
 */
function handleVerificationFailure(request) {
  try {
    const data = JSON.parse(request.postData.contents);
    const { name, email, amount, isRecurring } = data;

    // Send verification failure email
    sendVerificationFailureEmail({
      name,
      email,
      amount,
      isRecurring
    });

    // Log the verification failure
    console.log('Verification failure handled for:', email, 'Amount:', amount);

    return {
      success: true,
      message: 'Verification failure email sent successfully'
    };

  } catch (error) {
    console.error('Error handling verification failure:', error);
    return {
      success: false,
      error: 'Failed to handle verification failure'
    };
  }
}

/**
 * Handle subscription failure
 */
function handleSubscriptionFailure(request) {
  try {
    const data = JSON.parse(request.postData.contents);
    const { name, email, amount, errorReason } = data;

    // Send subscription failure email
    sendSubscriptionFailureEmail({
      name,
      email,
      amount,
      isRecurring: true
    }, errorReason);

    // Log the subscription failure
    console.log('Subscription failure handled for:', email, 'Amount:', amount);

    return {
      success: true,
      message: 'Subscription failure email sent successfully'
    };

  } catch (error) {
    console.error('Error handling subscription failure:', error);
    return {
      success: false,
      error: 'Failed to handle subscription failure'
    };
  }
}
/**
 * Creates a Razorpay Subscription via API.
 * This handles both fixed Plan IDs for preset amounts and
 * creates plans "on-the-fly" for custom user amounts.
 */
function createSubscription(request) {
  try {
    const data = JSON.parse(request.postData.contents);
    const { plan_id, amount } = data; // We expect either a plan_id OR an amount from the frontend

    let subscriptionData;

    if (plan_id) {
      // This runs when a user selects a preset amount (e.g., â‚¹500)
      console.log("Creating subscription from existing Plan ID:", plan_id);
      subscriptionData = {
        plan_id: plan_id,
        total_count: 60, // Total charges (e.g., 60 months = 5 years)
        customer_notify: 1
      };
    } else if (amount && amount >= 1) {
      // This runs when a user enters a custom amount
      console.log("Creating subscription with a new, on-the-fly plan for amount:", amount);
      subscriptionData = {
        plan: {
          period: 'monthly',
          interval: 1,
          item: {
            name: 'Custom Monthly Donation',
            description: 'A custom recurring contribution to YUVA Delhi.',
            amount: Math.round(amount * 100), // Amount must be in paise (e.g., 10000 for â‚¹100)
            currency: 'INR'
          }
        },
        total_count: 60,
        customer_notify: 1
      };
    } else {
      // If we didn't get a plan_id or a valid amount, return an error
      return { success: false, error: 'A valid Plan ID or custom amount is required.' };
    }

    // Call the helper function to make the API request
    const response = createRazorpaySubscription(subscriptionData);

    if (response.error || !response.id) {
      const errorMessage = response.error ? response.error.description : 'Failed to create subscription from Razorpay';
      throw new Error(errorMessage);
    }

    // If successful, return the new subscription ID to the frontend
    return {
      success: true,
      subscription: {
        id: response.id
      }
    };

  } catch (error) {
    console.error('Error in createSubscription:', error);
    return { success: false, error: 'Internal server error: ' + error.message };
  }
}

/**
 * Helper function that makes the actual API call to Razorpay's subscription endpoint.
 */
function createRazorpaySubscription(subscriptionData) {
  const url = 'https://api.razorpay.com/v1/subscriptions';
  const options = {
    method: 'POST',
    headers: {
      'Authorization': 'Basic ' + Utilities.base64Encode(CONFIG.RAZORPAY_KEY_ID + ':' + CONFIG.RAZORPAY_KEY_SECRET),
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify(subscriptionData),
    muteHttpExceptions: true // Prevents script from stopping on API errors
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    return JSON.parse(response.getContentText());
  } catch (error) {
    console.error('Razorpay Subscription API Call Error:', error);
    return { error: { description: error.toString() } };
  }
}

/**
 * Force initialize the sheet (can be called manually)
 */
function forceInitializeSheet() {
  try {
    console.log('Force initializing sheet...');
    const result = initializeSheet();

    if (result) {
      return {
        success: true,
        message: 'Sheet initialized successfully'
      };
    } else {
      return {
        success: false,
        error: 'Failed to initialize sheet'
      };
    }
  } catch (error) {
    console.error('Force initialization failed:', error);
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * Test function to verify setup
 */
function testSetup() {
  try {
    // Test sheet access and auto-initialization
    const sheet = getSheet();
    console.log('Sheet access: OK');

    // Check if headers exist
    const headers = sheet.getRange(1, 1, 1, 13).getValues()[0];
    const hasHeaders = headers[0] === 'Timestamp';
    console.log('Sheet headers:', hasHeaders ? 'OK' : 'Missing');

    // Test Razorpay API
    const testOrder = createRazorpayOrder({
      amount: 100,
      currency: 'INR',
      receipt: 'test_receipt'
    });

    if (testOrder.error) {
      console.log('Razorpay API Error:', testOrder.error);
    } else {
      console.log('Razorpay API: OK');
    }

    return {
      success: true,
      message: 'Setup test completed. Check logs for details.',
      details: {
        sheetAccess: true,
        headersPresent: hasHeaders,
        razorpayApi: !testOrder.error
      }
    };

  } catch (error) {
    console.error('Setup test failed:', error);
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * Test function to manually add data to sheet
 */
function testDataSave() {
  try {
    console.log('Testing data save...');

    const testData = {
      name: "Test User",
      email: "test@example.com",
      phone: "9876543210",
      city: "Delhi",
      amount: 100,
      isRecurring: false,
      paymentId: "test_payment_123",
      orderId: "test_order_123",
      signature: "test_signature"
    };

    const request = {
      postData: {
        contents: JSON.stringify(testData)
      }
    };

    const result = saveDonation(request);
    console.log('Test save result:', result);

    return result;
  } catch (error) {
    console.error('Test data save failed:', error);
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * Main doPost function to handle all requests
 */
function doPost(request) {
  try {
    // Parse request data from different sources
    let data = {};

    // Handle POST body data
    if (request.postData && request.postData.contents) {
      try {
        const postData = JSON.parse(request.postData.contents);
        data = { ...data, ...postData };
      } catch (e) {
        console.error('Error parsing POST data:', e);
      }
    }

    // Handle URL parameters
    if (request.parameter) {
      data = { ...data, ...request.parameter };
    }

    const path = data.path || '';
    console.log('Processing request for path:', path);

    let result;
    switch (path) {
      case 'create-order':
        result = createOrder(request);
        break;
      case 'verify-payment':
        result = verifyPayment(request);
        break;
      case 'save-donation':
        result = saveDonation(request);
        break;
      case 'donation-stats':
        result = getDonationStats(request);
        break;
      case 'webhook':
        result = handleWebhook(request);
        break;
      case 'test':
        result = testSetup();
        break;
      case 'test-save':
        result = testDataSave();
        break;
      case 'init-sheet':
        result = forceInitializeSheet();
        break;
      case 'payment-failed':
        result = handlePaymentFailure(request);
        break;
      case 'verification-failed':
        result = handleVerificationFailure(request);
        break;
      case 'subscription-failed':
        result = handleSubscriptionFailure(request);
        break;
      default:
        result = {
          success: false,
          error: 'Invalid endpoint: ' + path,
          availableEndpoints: ['create-order', 'verify-payment', 'save-donation', 'test']
        };
    }

    return createCorsResponse(result);

  } catch (error) {
    console.error('doPost error:', error);
    return createCorsResponse({
      success: false,
      error: 'Internal server error: ' + error.toString()
    });
  }
}

/**
 * REPLACE your existing doGet function with this one:
 */
function doGet(request) {
  try {
    const path = (request && request.parameter && request.parameter.path) || '';
    console.log('Processing GET request for path:', path);

    let result;
    switch (path) {
      case 'test':
        result = testSetup();
        break;
      case 'donation-stats':
        result = getDonationStats(request);
        break;
      case '':
      default:
        result = {
          success: true,
          message: 'YUVA Delhi Donation System API is running',
          timestamp: new Date().toISOString(),
          availableEndpoints: {
            GET: ['test', 'donation-stats'],
            POST: ['create-order', 'verify-payment', 'save-donation', 'payment-failed', 'verification-failed']
          }
        };
    }

    return createCorsResponse(result);

  } catch (error) {
    console.error('doGet error:', error);
    return createCorsResponse({
      success: false,
      error: 'Internal server error: ' + error.toString()
    });
  }
}

/**
 * ADD this new function (your existing code is missing this):
 */
// âœ… This is more explicit and reliable

/**
 * Correctly handles OPTIONS preflight requests for CORS.
 * This function provides the minimal valid response needed for Google's
 * servers to automatically handle the necessary CORS headers.
 */
function doOptions(e) {
  // Return a simple text output. The headers will be handled by Google's infrastructure.
  return ContentService.createTextOutput()
    .setMimeType(ContentService.MimeType.TEXT);
}

